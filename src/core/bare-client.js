// TompHTTP Bare Client v2.2.0-alpha
const fetch=globalThis.fetch,WebSocket=globalThis.WebSocket,Request=globalThis.Request,Response=globalThis.Response,WebSocketFields={prototype:{send:WebSocket.prototype.send},CLOSED:WebSocket.CLOSED,CLOSING:WebSocket.CLOSING,CONNECTING:WebSocket.CONNECTING,OPEN:WebSocket.OPEN},maxRedirects=20,statusEmpty=[101,204,205,304],statusRedirect=[301,302,303,307,308];class BareError extends Error{status;body;constructor(e,t){super(t.message||t.code),this.status=e,this.body=t}}class Client{base;constructor(e,t){this.base=new URL(`./v${e}/`,t)}}function safeAdd(e,t){const r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function bitRotateLeft(e,t){return e<<t|e>>>32-t}function md5cmn(e,t,r,s,n,o){return safeAdd(bitRotateLeft(safeAdd(safeAdd(t,e),safeAdd(s,o)),n),r)}function md5ff(e,t,r,s,n,o,i){return md5cmn(t&r|~t&s,e,t,n,o,i)}function md5gg(e,t,r,s,n,o,i){return md5cmn(t&s|r&~s,e,t,n,o,i)}function md5hh(e,t,r,s,n,o,i){return md5cmn(t^r^s,e,t,n,o,i)}function md5ii(e,t,r,s,n,o,i){return md5cmn(r^(t|~s),e,t,n,o,i)}function binlMD5(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;let r=1732584193,s=-271733879,n=-1732584194,o=271733878;for(let t=0;t<e.length;t+=16){const i=r,a=s,c=n,d=o;r=md5ff(r,s,n,o,e[t],7,-680876936),o=md5ff(o,r,s,n,e[t+1],12,-389564586),n=md5ff(n,o,r,s,e[t+2],17,606105819),s=md5ff(s,n,o,r,e[t+3],22,-1044525330),r=md5ff(r,s,n,o,e[t+4],7,-176418897),o=md5ff(o,r,s,n,e[t+5],12,1200080426),n=md5ff(n,o,r,s,e[t+6],17,-1473231341),s=md5ff(s,n,o,r,e[t+7],22,-45705983),r=md5ff(r,s,n,o,e[t+8],7,1770035416),o=md5ff(o,r,s,n,e[t+9],12,-1958414417),n=md5ff(n,o,r,s,e[t+10],17,-42063),s=md5ff(s,n,o,r,e[t+11],22,-1990404162),r=md5ff(r,s,n,o,e[t+12],7,1804603682),o=md5ff(o,r,s,n,e[t+13],12,-40341101),n=md5ff(n,o,r,s,e[t+14],17,-1502002290),s=md5ff(s,n,o,r,e[t+15],22,1236535329),r=md5gg(r,s,n,o,e[t+1],5,-165796510),o=md5gg(o,r,s,n,e[t+6],9,-1069501632),n=md5gg(n,o,r,s,e[t+11],14,643717713),s=md5gg(s,n,o,r,e[t],20,-373897302),r=md5gg(r,s,n,o,e[t+5],5,-701558691),o=md5gg(o,r,s,n,e[t+10],9,38016083),n=md5gg(n,o,r,s,e[t+15],14,-660478335),s=md5gg(s,n,o,r,e[t+4],20,-405537848),r=md5gg(r,s,n,o,e[t+9],5,568446438),o=md5gg(o,r,s,n,e[t+14],9,-1019803690),n=md5gg(n,o,r,s,e[t+3],14,-187363961),s=md5gg(s,n,o,r,e[t+8],20,1163531501),r=md5gg(r,s,n,o,e[t+13],5,-1444681467),o=md5gg(o,r,s,n,e[t+2],9,-51403784),n=md5gg(n,o,r,s,e[t+7],14,1735328473),s=md5gg(s,n,o,r,e[t+12],20,-1926607734),r=md5hh(r,s,n,o,e[t+5],4,-378558),o=md5hh(o,r,s,n,e[t+8],11,-2022574463),n=md5hh(n,o,r,s,e[t+11],16,1839030562),s=md5hh(s,n,o,r,e[t+14],23,-35309556),r=md5hh(r,s,n,o,e[t+1],4,-1530992060),o=md5hh(o,r,s,n,e[t+4],11,1272893353),n=md5hh(n,o,r,s,e[t+7],16,-155497632),s=md5hh(s,n,o,r,e[t+10],23,-1094730640),r=md5hh(r,s,n,o,e[t+13],4,681279174),o=md5hh(o,r,s,n,e[t],11,-358537222),n=md5hh(n,o,r,s,e[t+3],16,-722521979),s=md5hh(s,n,o,r,e[t+6],23,76029189),r=md5hh(r,s,n,o,e[t+9],4,-640364487),o=md5hh(o,r,s,n,e[t+12],11,-421815835),n=md5hh(n,o,r,s,e[t+15],16,530742520),s=md5hh(s,n,o,r,e[t+2],23,-995338651),r=md5ii(r,s,n,o,e[t],6,-198630844),o=md5ii(o,r,s,n,e[t+7],10,1126891415),n=md5ii(n,o,r,s,e[t+14],15,-1416354905),s=md5ii(s,n,o,r,e[t+5],21,-57434055),r=md5ii(r,s,n,o,e[t+12],6,1700485571),o=md5ii(o,r,s,n,e[t+3],10,-1894986606),n=md5ii(n,o,r,s,e[t+10],15,-1051523),s=md5ii(s,n,o,r,e[t+1],21,-2054922799),r=md5ii(r,s,n,o,e[t+8],6,1873313359),o=md5ii(o,r,s,n,e[t+15],10,-30611744),n=md5ii(n,o,r,s,e[t+6],15,-1560198380),s=md5ii(s,n,o,r,e[t+13],21,1309151649),r=md5ii(r,s,n,o,e[t+4],6,-145523070),o=md5ii(o,r,s,n,e[t+11],10,-1120210379),n=md5ii(n,o,r,s,e[t+2],15,718787259),s=md5ii(s,n,o,r,e[t+9],21,-343485551),r=safeAdd(r,i),s=safeAdd(s,a),n=safeAdd(n,c),o=safeAdd(o,d)}return[r,s,n,o]}function binl2rstr(e){let t="";const r=32*e.length;for(let s=0;s<r;s+=8)t+=String.fromCharCode(e[s>>5]>>>s%32&255);return t}function rstr2binl(e){const t=[],r=e.length>>2;for(let e=0;e<r;e+=1)t[e]=0;const s=8*e.length;for(let r=0;r<s;r+=8)t[r>>5]|=(255&e.charCodeAt(r/8))<<r%32;return t}function rstrMD5(e){return binl2rstr(binlMD5(rstr2binl(e),8*e.length))}function rstrHMACMD5(e,t){let r=rstr2binl(e);const s=[],n=[];r.length>16&&(r=binlMD5(r,8*e.length));for(let e=0;e<16;e+=1)s[e]=909522486^r[e],n[e]=1549556828^r[e];const o=binlMD5(s.concat(rstr2binl(t)),512+8*t.length);return binl2rstr(binlMD5(n.concat(o),640))}function rstr2hex(e){const t="0123456789abcdef";let r="";for(let s=0;s<e.length;s+=1){const n=e.charCodeAt(s);r+=t.charAt(n>>>4&15)+t.charAt(15&n)}return r}function str2rstrUTF8(e){return unescape(encodeURIComponent(e))}function rawMD5(e){return rstrMD5(str2rstrUTF8(e))}function hexMD5(e){return rstr2hex(rawMD5(e))}function rawHMACMD5(e,t){return rstrHMACMD5(str2rstrUTF8(e),str2rstrUTF8(t))}function hexHMACMD5(e,t){return rstr2hex(rawHMACMD5(e,t))}function md5(e,t,r){return t?r?rawHMACMD5(t,e):hexHMACMD5(t,e):r?rawMD5(e):hexMD5(e)}const MAX_HEADER_VALUE=3072;function splitHeaders(e){const t=new Headers(e);if(e.has("x-bare-headers")){const r=e.get("x-bare-headers");if(r.length>3072){t.delete("x-bare-headers");let e=0;for(let s=0;s<r.length;s+=3072){const n=r.slice(s,s+3072),o=e++;t.set(`x-bare-headers-${o}`,`;${n}`)}}}return t}function joinHeaders(e){const t=new Headers(e),r="x-bare-headers";if(e.has(`${r}-0`)){const s=[];for(const[n,o]of e){if(!n.startsWith(r))continue;if(!o.startsWith(";"))throw new BareError(400,{code:"INVALID_BARE_HEADER",id:`request.headers.${n}`,message:"Value didn't begin with semi-colon."});s[parseInt(n.slice(15))]=o.slice(1),t.delete(n)}t.set(r,s.join(""))}return t}class ClientV3 extends Client{ws;http;constructor(e){super(3,e),this.ws=new URL(this.base),this.http=new URL(this.base),"https:"===this.ws.protocol?this.ws.protocol="wss:":this.ws.protocol="ws:"}connect(e,t,r,s,n){const o=new WebSocket(this.ws),i=()=>{o.removeEventListener("close",a),o.removeEventListener("message",c)},a=()=>{i()},c=e=>{if(i(),"string"!=typeof e.data)throw new TypeError("the first websocket message was not a text frame");const t=JSON.parse(e.data);if("open"!==t.type)throw new TypeError("message was not of open type");e.stopImmediatePropagation(),s({protocol:t.protocol,setCookies:t.setCookies}),n(WebSocketFields.OPEN),o.dispatchEvent(new Event("open"))};return o.addEventListener("close",a),o.addEventListener("message",c),o.addEventListener("open",(s=>{s.stopImmediatePropagation(),n(WebSocketFields.CONNECTING),r().then((r=>WebSocketFields.prototype.send.call(o,JSON.stringify({type:"connect",remote:e.toString(),protocols:t,headers:r,forwardHeaders:[]}))))}),{once:!0}),o}async request(e,t,r,s,n,o,i){if(s.protocol.startsWith("blob:")){const e=await fetch(s),t=new Response(e.body,e);return t.rawHeaders=Object.fromEntries(e.headers),t.rawResponse=e,t}const a={};if(t instanceof Headers)for(const[e,r]of t)a[e]=r;else for(const e in t)a[e]=t[e];const c={credentials:"omit",method:e,signal:i};"only-if-cached"!==n&&(c.cache=n),void 0!==r&&(c.body=r),void 0!==o&&(c.duplex=o),c.headers=this.createBareHeaders(s,a);const d=await fetch(this.http+"?cache="+md5(s.toString()),c),h=await this.readBareResponse(d),l=new Response(statusEmpty.includes(h.status)?void 0:d.body,{status:h.status,statusText:h.statusText??void 0,headers:new Headers(h.headers)});return l.rawHeaders=h.headers,l.rawResponse=d,l}async readBareResponse(e){if(!e.ok)throw new BareError(e.status,await e.json());const t=joinHeaders(e.headers),r={},s=t.get("x-bare-status");null!==s&&(r.status=parseInt(s));const n=t.get("x-bare-status-text");null!==n&&(r.statusText=n);const o=t.get("x-bare-headers");return null!==o&&(r.headers=JSON.parse(o)),r}createBareHeaders(e,t,r=[],s=[],n=[]){const o=new Headers;o.set("x-bare-url",e.toString()),o.set("x-bare-headers",JSON.stringify(t));for(const e of r)o.append("x-bare-forward-headers",e);for(const e of s)o.append("x-bare-pass-headers",e);for(const e of n)o.append("x-bare-pass-status",e.toString());return splitHeaders(o),o}}const validChars="!#$%&'*+-.0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ^_`abcdefghijklmnopqrstuvwxyz|~";function validProtocol(e){for(let t=0;t<e.length;t++){const r=e[t];if(!validChars.includes(r))return!1}return!0}const clientCtors=[["v3",ClientV3]];async function fetchManifest(e,t){const r=await fetch(e,{signal:t});if(!r.ok)throw new Error(`Unable to fetch Bare meta: ${r.status} ${await r.text()}`);return await r.json()}const getRealReadyState=Object.getOwnPropertyDescriptor(WebSocket.prototype,"readyState").get,wsProtocols=["ws:","wss:"];class BareClient{manifest;client;server;working;onDemand;onDemandSignal;constructor(e,t){this.server=new URL(e),!t||t instanceof AbortSignal?(this.onDemand=!0,this.onDemandSignal=t):(this.onDemand=!1,this.loadManifest(t))}loadManifest(e){return this.manifest=e,this.client=this.getClient(),this.client}demand(){return this.onDemand?(this.working||(this.working=fetchManifest(this.server,this.onDemandSignal).then((e=>this.loadManifest(e))).catch((e=>{throw delete this.working,e}))),this.working):this.client}getClient(){for(const[e,t]of clientCtors)if(this.manifest.versions.includes(e))return new t(this.server);throw new Error("Unable to find compatible client version. Starting from v2.0.0, @tomphttp/bare-client only supports Bare servers v3+. For more information, see https://github.com/tomphttp/bare-client/")}createWebSocket(e,t=[],r){if(!this.client)throw new TypeError("You need to wait for the client to finish fetching the manifest before creating any WebSockets. Try caching the manifest data before making this request.");try{e=new URL(e)}catch(t){throw new DOMException(`Faiiled to construct 'WebSocket': The URL '${e}' is invalid.`)}if(!wsProtocols.includes(e.protocol))throw new DOMException(`Failed to construct 'WebSocket': The URL's scheme must be either 'ws' or 'wss'. '${e.protocol}' is not allowed.`);Array.isArray(t)||(t=[t]),t=t.map(String);for(const e of t)if(!validProtocol(e))throw new DOMException(`Failed to construct 'WebSocket': The subprotocol '${e}' is invalid.`);const s=this.client.connect(e,t,(async()=>{const t="function"==typeof r.headers?await r.headers():r.headers||{},s=t instanceof Headers?Object.fromEntries(t):t;return s.Host=e.host,s.Pragma="no-cache",s["Cache-Control"]="no-cache",s.Upgrade="websocket",s.Connection="Upgrade",s}),(e=>{n=e.protocol,r.setCookiesCallback&&r.setCookiesCallback(e.setCookies)}),(e=>{o=e}),r.webSocketImpl||WebSocket);let n="",o=WebSocketFields.CONNECTING;const i=()=>{const e=getRealReadyState.call(s);return e===WebSocketFields.OPEN?o:e};r.readyStateHook?r.readyStateHook(s,i):Object.defineProperty(s,"readyState",{get:i,configurable:!0,enumerable:!0});const a=()=>{if(i()===WebSocketFields.CONNECTING)return new DOMException("Failed to execute 'send' on 'WebSocket': Still in CONNECTING state.")};r.sendErrorHook?r.sendErrorHook(s,a):s.send=function(...e){const t=a();if(t)throw t;WebSocketFields.prototype.send.call(this,...e)},r.urlHook?r.urlHook(s,e):Object.defineProperty(s,"url",{get:()=>e.toString(),configurable:!0,enumerable:!0});const c=()=>n;return r.protocolHook?r.protocolHook(s,c):Object.defineProperty(s,"protocol",{get:c,configurable:!0,enumerable:!0}),s}async fetch(e,t){const r=isUrlLike(e)?new Request(e,t):e,s=t?.headers||r.headers,n=s instanceof Headers?Object.fromEntries(s):s,o=t?.duplex,i=t?.body||r.body;let a=new URL(r.url);const c=await this.demand();for(let e=0;;e++){"host"in n?n.host=a.host:n.Host=a.host;const s=await c.request(r.method,n,i,a,r.cache,o,r.signal);s.finalURL=a.toString();const d=t?.redirect||r.redirect;if(!statusRedirect.includes(s.status))return s;switch(d){case"follow":{const t=s.headers.get("location");if(20>e&&null!==t){a=new URL(t,a);continue}throw new TypeError("Failed to fetch")}case"error":throw new TypeError("Failed to fetch");case"manual":return s}}}}function isUrlLike(e){return"string"==typeof e||e instanceof URL}async function createBareClient(e,t){const r=await fetchManifest(e,t);return new BareClient(e,r)}export{BareClient,BareError,Client,createBareClient,fetchManifest,maxRedirects,statusEmpty,statusRedirect};
//# sourceMappingURL=https://cdn.jsdelivr.net/sm/9266d23158e5be67cb965d64c82ee3b27cdc45f91c2135bc872c7446f6dc32eb.map
